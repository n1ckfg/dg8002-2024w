<!DOCTYPE html>
<html>
  <head>
    <style>
      html, body {
        overscroll-behavior: none;
        touch-action: none;
        margin: 0px;
      }    

      canvas {
        display: block;
      } 
    </style>
    <script src="https://github.com/processing/p5.js/releases/download/v1.9.0/p5.min.js"></script>
    <script>  
      let bgColor;
      let alphaVal = 103;
      let isDrawing = false;
      let strokes = [];
      let armDelete = false;

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
      }

      function setup() {
        createCanvas(windowWidth, windowHeight, WEBGL);
        bgColor = color(127);
      }
      
      function draw() {              
        background(bgColor);

        if (armDelete) {
          strokes = []; 
          console.log("all strokes deleted, total: " + strokes.length);
          armDelete = false;
        }

        if (mouseIsPressed && isDrawing && strokes.length > 0) {
          let x = mouseX - (width/2);
          let y = mouseY - (height/2);
          let px = pmouseX - (width/2);
          let py = pmouseY - (height/2);
          
          let distVal = dist(x, y, px, py);
          //console.log(distVal);
          let mapVal = map(distVal, 0, 40, 5, 15);
          strokes[strokes.length-1].points.push(createVector(x, y, mapVal));
        }

        for (let i=0; i<strokes.length; i++) {
          if (strokes[i].alive) {
            strokes[i].draw();
          } else {
            strokes.splice(i, 1);
            console.log("stroke deleted, total: " + strokes.length);
          }
        }
      }
      
      function mousePressed() {
        if (!isDrawing) {
          strokes.push(new Stroke());
          console.log("stroke added, total: " + strokes.length);
          isDrawing = true;
        }
      }

      function mouseReleased() {
        isDrawing = false;
      }

      function keyReleased() {
        switch(key) {
          case ' ':
            armDelete = true;
            break;            
        }
      }
      
      function randomColor() {
        return color(random(127, 255), random(127, 255), random(127, 255), alphaVal);
      }

      class Stroke {

          constructor() {
            this.color = randomColor();
            this.points = [];
            this.alive = true;
            this.falling = false;
            this.timestamp = millis();
            this.falltime = random(500, 1000);
            this.lifetime = 20000;
          }

          draw() {
            if (millis() > this.timestamp + this.falltime) this.falling = true;
            if (millis() > this.timestamp + this.lifetime) this.alive = false;

            if (this.alive) {
              for (let i=1; i<this.points.length; i++) {
                strokeWeight(this.points[i].z + 3);
                stroke(0, alphaVal);
                line(this.points[i].x, this.points[i].y, this.points[i-1].x, this.points[i-1].y);
                
                strokeWeight(this.points[i].z);
                stroke(this.color);
                line(this.points[i].x, this.points[i].y, this.points[i-1].x, this.points[i-1].y);              
                
                if (this.falling) {
                  let fallSpeed = random(0.0, this.points[i].z * 0.2)
                  this.points[i-1].y += fallSpeed;
                  this.points[i].y += fallSpeed;
                }
              }
            }
          }

      }
    </script>
  </head>
  <body>
  </body>
</html>
